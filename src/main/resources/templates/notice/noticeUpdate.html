<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/exampleLayout}">

<head>
    <title>공지사항 수정</title>
    <th:block layout:fragment="script">
        <meta name="_csrf" th:content="${_csrf?.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

        <script th:inline="javascript">
            $(document).ready(function() {
                // 전체선택
                $("#checkAll").click(function() {
                    $(".chk").prop("checked", $(this).prop("checked"));
                });

                // 개별 파일 삭제 처리
                window.fileDeleteCheck = function(file) {
                    const token = $("meta[name='_csrf']").attr("content");
                    const header = $("meta[name='_csrf_header']").attr("content");

                    if (!confirm("현재 파일을 삭제하시겠습니까?")) return false;

                    $.ajax({
                        type: "POST",
                        url: "/notice/fileDeleteCheck",  // 서버에서 처리하는 URL
                        data: { file: file },
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader(header, token);
                        },
                        success: function(res) {
                            if (res !== "0") {
                                alert("파일이 삭제되었습니다.");
                                location.reload();
                            } else {
                                alert("삭제에 실패했습니다.");
                            }
                        },
                        error: function() {
                            alert("전송 오류가 발생했습니다.");
                        }
                    });
                };

                // 선택된 파일들 모두 삭제처리
                window.selectDelCheck = function() {
                    const token = $("meta[name='_csrf']").attr("content");
                    const header = $("meta[name='_csrf_header']").attr("content");

                    if (!confirm("선택된 파일을 삭제하시겠습니까?")) return false;

                    let delItems = "";
                    $("input[name='chk']:checked").each(function() {
                        delItems += $(this).val() + "/";
                    });

                    if (delItems === "") {
                        alert('한 개 이상의 파일을 선택 후 처리하세요.');
                        return false;
                    }

                    $.ajax({
                        type: "post",
                        url: "/notice/fileSelectDelete",
                        data: { delItems: delItems },
                        beforeSend: function(xhr) { xhr.setRequestHeader(header, token); },
                        success: function(res) {
                            if (res !== "0") {
                                alert("파일이 삭제되었습니다.");
                                location.reload();
                            }
                        },
                        error: function() { alert("전송오류!"); }
                    });
                };

                // 스크롤 시 상단으로 부드럽게 이동 버튼 토글
                $(window).scroll(function() {
                    if ($(this).scrollTop() > 100) {
                        $("#topBtn").addClass("on");
                    } else {
                        $("#topBtn").removeClass("on");
                    }
                });

                $("#topBtn").click(function() {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            });
        </script>
    </th:block>
</head>

<body>
<div layout:fragment="content">
    <div class="form-container">
        <h3 class="text-center mb-4">공지사항 수정</h3>
        <form name="myform" method="post" enctype="multipart/form-data">
            <table class="table table-bordered align-middle">
                <tbody>
                    <tr>
                        <th class="required">제목</th>
                        <td>
                            <input type="text" name="title" id="title" class="form-control" required autofocus
                                   th:value="${notice.title}" />
                        </td>
                    </tr>
                    <tr>
                        <th class="required">작성자</th>
                        <td>
                            <input type="text" name="writer" id="writer" class="form-control" required
                                   th:value="${notice.writer}" />
                        </td>
                    </tr>
                    <tr>
                        <th>내용</th>
                        <td>
                            <textarea rows="8" name="content" id="content" class="form-control"
                                      th:text="${notice.content}"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="bg-light text-center">첨부 파일</th>
                        <td colspan="3">
                            <th:block th:if="${fileList != null and !#lists.isEmpty(fileList)}">
                                <th:block th:each="file : ${fileList}">
                                    <div class="d-inline-block me-3 mb-2">
                                        <a th:href="@{/upload/{file}(file=${file})}"
                                           th:text="${file}"
                                           th:download="${file}"
                                           th:title="'파일 다운로드: ' + ${file}"
                                           class="text-decoration-none text-primary me-2">
                                        </a>
                                    </div>
                                </th:block>
                            </th:block>
                            <th:block th:if="${fileList == null or #lists.isEmpty(fileList)}">
                                <span class="text-muted">첨부 파일 없음</span>
                            </th:block>
                        </td>
                    </tr>
                </tbody>
            </table>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="text-center">
                <button type="submit" class="btn btn-save me-2">저장</button>
                <button type="button" class="btn btn-cancel"
                        th:onclick="|location.href='@{/notice/noticeMain}'|">취소</button>
            </div>
        </form>
    </div>
</div>
</body>
</html>