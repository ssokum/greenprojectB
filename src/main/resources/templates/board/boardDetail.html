<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/exampleLayout}">

<head>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<th:block layout:fragment="script">
  <script th:inline="javascript">
    function addComment(boardId) {
      const content = $("#commentContent").val().trim();
      if (!content) {
        alert("댓글 내용을 입력하세요.");
        return;
      }

      const csrfToken = $("meta[name='_csrf']").attr("content");
      const csrfHeader = $("meta[name='_csrf_header']").attr("content");

      $.ajax({
        url: "/board/" + boardId + "/comment",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ content: content }),
        beforeSend: function(xhr) {
          xhr.setRequestHeader(csrfHeader, csrfToken);
        },
        success: function(data) {
          if (data.success) {
            const newComment = `
              <li class="list-group-item border-0 border-bottom">
                <div class="d-flex justify-content-between mb-1">
                  <strong>${data.comment.memberName}</strong>
                  <small class="text-muted">${data.comment.createdAt}</small>
                </div>
                <div class="ms-1">${data.comment.content}</div>
              </li>
            `;
            $("#commentList").append(newComment);
            $("#commentContent").val("");
          } else {
            alert("댓글 등록 실패");
          }
        },
        error: function(err) {
          console.error("에러 발생:", err);
          alert("오류가 발생했습니다.");
        }
      });
    }

  </script>
</th:block>

<div layout:fragment="content" class="container mt-4" style="max-width: 700px;">
  <h2 class="mb-3" th:text="${board.title}">게시글 제목</h2>
  <div class="mb-2 text-muted">
    조회수: <span th:text="${board.viewCount}"></span>
  </div>
  <div class="border p-3 mb-3" style="white-space: pre-wrap;" th:text="${board.content}">
    게시글 내용
  </div>

  <!-- 목록 / 삭제 버튼 -->
  <div class="text-end d-flex justify-content-end gap-2">
    <a th:href="@{/board/boardList}" class="btn btn-secondary">목록</a>
    <th:block th:if="${loginId == board.member.memberId or loginRole == 'ADMIN'}">
      <form th:action="@{'/board/boardDelete/' + ${board.boardIdx}}" method="post"
            onsubmit="return confirm('정말 삭제하시겠습니까?')">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn-danger">삭제</button>
      </form>
    </th:block>
  </div>

  <!-- 댓글 -->
  <div class="mt-5">
    <h5>댓글</h5>
    <ul class="list-group mb-3" id="commentList">
      <li class="list-group-item border-0 border-bottom" th:each="comment : ${board.comments}">
        <div class="d-flex justify-content-between mb-1">
          <strong th:text="${comment.member.memberName}">작성자</strong>
          <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</small>
        </div>
        <div class="ms-1" th:text="${comment.content}">댓글 내용</div>
      </li>
    </ul>

    <div class="mb-3">
      <textarea id="commentContent" class="form-control" rows="3" placeholder="댓글을 입력하세요." required></textarea>
    </div>
    <button type="button" class="btn btn-outline-primary"
            th:onclick="'addComment(' + ${board.boardIdx} + ')'">댓글 작성</button>
  </div>
</div>
</html>
